<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Metrics</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            font-size: 14px;
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            font-weight: 600;
            color: #333;
        }
        
        .metric-value {
            color: #0079bf;
            font-weight: 600;
        }
        
        .timeline {
            margin-top: 20px;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
        }
        
        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .timeline-dot.start { background: #28a745; }
        .timeline-dot.progress { background: #ffc107; }
        .timeline-dot.done { background: #0079bf; }
        .timeline-dot.other { background: #6c757d; }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-list {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .timeline-date {
            color: #666;
            font-size: 12px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #0079bf;
        }
    </style>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
    <div id="loading" class="loading">
        Loading card metrics...
    </div>
    
    <div id="error" class="error" style="display: none;"></div>
    
    <div id="content" style="display: none;">
        <h3 id="cardName"></h3>
        
        <div class="metric-row">
            <span class="metric-label">Lead Time:</span>
            <span class="metric-value" id="leadTime">-</span>
        </div>
        
        <div class="metric-row">
            <span class="metric-label">Cycle Time:</span>
            <span class="metric-value" id="cycleTime">-</span>
        </div>
        
        <div class="metric-row">
            <span class="metric-label">Status:</span>
            <span class="metric-value" id="status">-</span>
        </div>
        
        <div class="metric-row">
            <span class="metric-label">Current List:</span>
            <span class="metric-value" id="currentList">-</span>
        </div>
        
        <div class="timeline">
            <h3>Movement History</h3>
            <div id="timelineContent"></div>
        </div>
    </div>

    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
        let t = TrelloPowerUp.iframe();
        
        t.render(async function() {
            try {
                await loadCardMetrics();
            } catch (error) {
                showError('Failed to load card metrics: ' + error.message);
            }
        });
        
        async function loadCardMetrics() {
            try {
                // Get workflow config
                const config = await t.get('board', 'shared', 'workflowConfig', {});
                
                if (!config.startLists || !config.doneLists) {
                    showError('Please configure your workflow settings first from the board menu.');
                    return;
                }
                
                // Get card info
                const card = await t.card('id', 'name', 'idList');
                
                // Get current list name
                const lists = await t.lists('id', 'name');
                const currentList = lists.find(l => l.id === card.idList);
                
                // For now, show current card status without historical data
                // TODO: Implement proper action history retrieval
                console.log('Card info:', card);
                console.log('Current list:', currentList);
                console.log('Config:', config);
                
                // Show current status and explain limitation
                showError('Card movement history is not yet available. Currently showing card status based on current list position only.');
                
                // Determine current status based on list position
                let currentStatus = 'other';
                if (config.startLists && config.startLists.includes(card.idList)) {
                    currentStatus = 'start';
                } else if (config.progressLists && config.progressLists.includes(card.idList)) {
                    currentStatus = 'progress';
                } else if (config.doneLists && config.doneLists.includes(card.idList)) {
                    currentStatus = 'done';
                }
                
                // Create a mock movement for current position
                const mockMovements = [{
                    date: new Date().toISOString(),
                    listId: card.idList,
                    listName: currentList ? currentList.name : 'Unknown',
                    type: currentStatus
                }];
                
                displayCardMetrics(card, {
                    leadTimeDays: null,
                    cycleTimeDays: null,
                    isCompleted: config.doneLists && config.doneLists.includes(card.idList),
                    movements: mockMovements
                }, currentList);
                return;
                
                // Calculate metrics
                const metrics = calculateDetailedCardMetrics(card, actions, config, lists);
                
                // Display results
                displayCardMetrics(card, metrics, currentList);
                
            } catch (error) {
                console.error('Error in loadCardMetrics:', error);
                showError('Failed to load card metrics: ' + error.message);
            }
        }
        
        function calculateDetailedCardMetrics(card, actions, config, lists) {
            if (!actions || actions.length === 0) {
                return {
                    leadTimeDays: null,
                    cycleTimeDays: null,
                    isCompleted: false,
                    movements: []
                };
            }
            
            // Sort and process movements
            const movements = actions
                .filter(action => action.type === 'updateCard' && action.data.listAfter)
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .map(action => {
                    const listAfter = lists.find(l => l.id === action.data.listAfter.id);
                    return {
                        date: action.date,
                        listId: action.data.listAfter.id,
                        listName: listAfter ? listAfter.name : action.data.listAfter.name,
                        type: getListType(action.data.listAfter.id, config)
                    };
                });
            
            // Find key dates
            let workflowStart = null;
            let workStart = null; 
            let completion = null;
            let isCompleted = false;
            
            for (const movement of movements) {
                if (!workflowStart && config.startLists.includes(movement.listId)) {
                    workflowStart = new Date(movement.date);
                }
                if (!workStart && config.progressLists && config.progressLists.includes(movement.listId)) {
                    workStart = new Date(movement.date);
                }
                if (config.doneLists.includes(movement.listId)) {
                    completion = new Date(movement.date);
                    isCompleted = true;
                    break;
                }
            }
            
            // Check if currently in done list
            if (!isCompleted && config.doneLists.includes(card.idList)) {
                isCompleted = true;
                completion = new Date();
            }
            
            // Calculate times
            let leadTimeDays = null;
            let cycleTimeDays = null;
            
            if (workflowStart && completion) {
                leadTimeDays = (completion - workflowStart) / (1000 * 60 * 60 * 24);
            }
            
            if (workStart && completion) {
                cycleTimeDays = (completion - workStart) / (1000 * 60 * 60 * 24);
            }
            
            return {
                leadTimeDays,
                cycleTimeDays,
                isCompleted,
                movements,
                workflowStart,
                workStart,
                completion
            };
        }
        
        function getListType(listId, config) {
            if (config.startLists.includes(listId)) return 'start';
            if (config.progressLists && config.progressLists.includes(listId)) return 'progress';
            if (config.doneLists.includes(listId)) return 'done';
            return 'other';
        }
        
        function displayCardMetrics(card, metrics, currentList) {
            document.getElementById('cardName').textContent = card.name;
            
            document.getElementById('leadTime').textContent = 
                metrics.leadTimeDays ? `${metrics.leadTimeDays.toFixed(1)} days` : 'Not available';
            
            document.getElementById('cycleTime').textContent = 
                metrics.cycleTimeDays ? `${metrics.cycleTimeDays.toFixed(1)} days` : 'Not available';
            
            document.getElementById('status').textContent = 
                metrics.isCompleted ? 'Completed' : 'In Progress';
            
            document.getElementById('currentList').textContent = 
                currentList ? currentList.name : 'Unknown';
            
            // Display timeline
            const timelineContent = document.getElementById('timelineContent');
            timelineContent.innerHTML = '';
            
            if (metrics.movements.length === 0) {
                timelineContent.innerHTML = '<p>No movement history available.</p>';
            } else {
                metrics.movements.forEach(movement => {
                    const item = document.createElement('div');
                    item.className = 'timeline-item';
                    
                    const dot = document.createElement('div');
                    dot.className = `timeline-dot ${movement.type}`;
                    
                    const content = document.createElement('div');
                    content.className = 'timeline-content';
                    
                    const listDiv = document.createElement('div');
                    listDiv.className = 'timeline-list';
                    listDiv.textContent = movement.listName;
                    
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'timeline-date';
                    dateDiv.textContent = new Date(movement.date).toLocaleString();
                    
                    content.appendChild(listDiv);
                    content.appendChild(dateDiv);
                    
                    item.appendChild(dot);
                    item.appendChild(content);
                    
                    timelineContent.appendChild(item);
                });
            }
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }
        
        // Initialize iframe
        TrelloPowerUp.iframe();
    </script>
</body>
</html>